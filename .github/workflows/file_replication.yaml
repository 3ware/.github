name: Replicate Files

on:
  workflow_dispatch: {}
  push:
    branches: [main]

permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  get-temp-token:
    uses: 3ware/workflows/.github/workflows/get-workflow-token.yaml@57a900982a56bebaf91e660a56adb7f021690d15 # v4.0.0
    secrets: inherit

  replicate-files:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [get-temp-token]
    steps:
      - name: Decrypt the installation access token
        id: decrypt-token
        run: |
          DECRYPTED_TOKEN=$(gpg --decrypt --quiet --batch --passphrase "$KEY" \
          --output - <(echo "${{ needs.get-temp-token.outputs.temp-token }}" \
          | base64 --decode))
          echo "::add-mask::$DECRYPTED_TOKEN"
          echo "temp-token=$DECRYPTED_TOKEN" >> $GITHUB_OUTPUT
        env:
          KEY: ${{ secrets.PGP_SECRET_SIGNING_PASSPHRASE }}

      - name: Checkout repository
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.0.0
        with:
          token: ${{ steps.decrypt-token.outputs.temp-token }}

      - name: Replicate files
        uses: derberg/manage-files-in-multiple-repositories@beecbe897cf5ed7f3de5a791a3f2d70102fe7c25 # v2
        with:
          github_token: ${{ steps.decrypt-token.outputs.temp-token }}
          patterns_to_include: '.releaserc.json'
          exclude_private: true
          exclude_forked: true
          repos_to_ignore: 'workflows,www-src'
